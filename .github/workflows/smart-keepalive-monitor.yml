name: üõ°Ô∏è Keep Alive + Health Monitor

on:
  schedule:
    # Ogni 30 minuti - ottimo equilibrio tra prevenzione e monitoring
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  smart-keepalive:
    runs-on: ubuntu-latest
    name: Keep Alive Intelligente
    
    steps:
      - name: üèì Keep Alive con Detection
        id: keepalive_check
        run: |
          echo "üèì Keep Alive check (ogni 30min)"
          echo "üìç Scopo: Prevenire sleep + Rilevare downtime"
          
          APP_URL="${{ secrets.HEALTH_CHECK_URL }}"
          SUCCESS=false
          FINAL_STATUS=""
          FINAL_TIME=""
          ERROR_DETAILS=""
          
          # 3 tentativi con delay crescente
          for attempt in 1 2 3; do
            echo ""
            echo "üîÑ Tentativo $attempt/3"
            
            # Keep alive ping con dettagli
            response=$(curl -s -w "\nTIME:%{time_total}s\nSTATUS:%{http_code}" \
              --max-time 30 \
              --user-agent "Karaokati-KeepAlive-Monitor/1.0" \
              "$APP_URL/health" 2>/dev/null)
            
            curl_exit_code=$?
            
            if [[ $curl_exit_code -eq 0 ]]; then
              # Parse response
              status_code=$(echo "$response" | grep -o "STATUS:[0-9]*" | cut -d: -f2)
              time_taken=$(echo "$response" | grep -o "TIME:[0-9.]*" | cut -d: -f2)
              body=$(echo "$response" | sed '/TIME:/d; /STATUS:/d')
              
              FINAL_STATUS="$status_code"
              FINAL_TIME="$time_taken"
              
              echo "üìä Status: $status_code"
              echo "‚è±Ô∏è  Time: ${time_taken}s"
              
              if [[ "$status_code" == "200" ]]; then
                # Success - check if app was sleeping (>5s = cold start)
                time_ms=$(echo "$time_taken" | awk '{print int($1 * 1000)}')
                if [ "$time_ms" -gt 5000 ]; then
                  echo "üò¥ Cold start detected (${time_taken}s) - app was sleeping!"
                  echo "‚úÖ Keep alive successful - app awakened"
                else
                  echo "‚úÖ Keep alive successful - app was already warm"
                fi
                
                SUCCESS=true
                break
              else
                echo "‚ùå HTTP Error: $status_code"
                ERROR_DETAILS="HTTP $status_code"
              fi
            else
              echo "üö´ Connection failed (timeout/network error)"
              ERROR_DETAILS="Connection timeout/network error"
              FINAL_STATUS="TIMEOUT"
            fi
            
            # Delay progressivo tra retry (30s, 60s)
            if [[ $attempt -lt 3 ]]; then
              delay=$((30 * attempt))
              echo "‚è≥ Waiting ${delay}s before retry..."
              sleep $delay
            fi
          done
          
          # Export results per step successivi
          echo "SUCCESS=$SUCCESS" >> $GITHUB_OUTPUT
          echo "STATUS_CODE=$FINAL_STATUS" >> $GITHUB_OUTPUT
          echo "RESPONSE_TIME=$FINAL_TIME" >> $GITHUB_OUTPUT
          echo "ERROR_DETAILS=$ERROR_DETAILS" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          
          if [[ "$SUCCESS" == "true" ]]; then
            echo ""
            echo "üéØ KEEP ALIVE SUCCESS!"
            echo "   ‚Ä¢ Sleep prevention: ‚úÖ"
            echo "   ‚Ä¢ App health: ‚úÖ" 
            echo "   ‚Ä¢ Next check: 30 minutes"
          else
            echo ""
            echo "üö® KEEP ALIVE FAILED!"
            echo "   ‚Ä¢ App appears down: ‚ùå"
            echo "   ‚Ä¢ Alert will be sent: üìß"
          fi

      - name: üìß Send Email Alert con Resend
        if: steps.keepalive_check.outputs.SUCCESS == 'false'
        run: |
          echo "üìß Sending alert email via Resend API..."
          
          # Prepare email content
          EMAIL_SUBJECT="üö® KARAOKATI DOWN - Keep Alive Failed (${{ steps.keepalive_check.outputs.TIMESTAMP }})"
          EMAIL_HTML='<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: #dc3545; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
              <h1 style="margin: 0; font-size: 24px;">üö® Karaokati App Down Alert</h1>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border: 1px solid #dee2e6;">
              <h2 style="color: #dc3545; margin-top: 0;">‚ö†Ô∏è Keep Alive Check Failed</h2>
              
              <div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <h3 style="margin-top: 0; color: #495057;">üîç Failure Details:</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold; width: 40%;">App URL:</td>
                    <td style="padding: 8px 0;">https://api.karaokati.com</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Check Time:</td>
                    <td style="padding: 8px 0;">${{ steps.keepalive_check.outputs.TIMESTAMP }}</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Status:</td>
                    <td style="padding: 8px 0; color: #dc3545;">${{ steps.keepalive_check.outputs.STATUS_CODE || 'UNKNOWN' }}</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Response Time:</td>
                    <td style="padding: 8px 0;">${{ steps.keepalive_check.outputs.RESPONSE_TIME || 'N/A' }}s</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Error:</td>
                    <td style="padding: 8px 0; color: #dc3545;">${{ steps.keepalive_check.outputs.ERROR_DETAILS }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold;">Retries:</td>
                    <td style="padding: 8px 0;">3 attempts failed</td>
                  </tr>
                </table>
              </div>
              
              <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <h3 style="margin-top: 0; color: #856404;">üîß Immediate Actions Required:</h3>
                <ol style="margin: 0; padding-left: 20px; color: #856404;">
                  <li>Check <strong>Railway Dashboard</strong> for service status</li>
                  <li>Review <strong>deployment logs</strong> for errors</li>
                  <li>Verify <strong>database connectivity</strong></li>
                  <li>Consider <strong>manual redeploy</strong> if needed</li>
                  <li>Check for <strong>resource limits</strong> reached</li>
                </ol>
              </div>
              
              <div style="background: #d1ecf1; border: 1px solid #b8daff; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <h3 style="margin-top: 0; color: #0c5460;">üîó Quick Access Links:</h3>
                <ul style="margin: 0; padding-left: 20px; color: #0c5460;">
                  <li><a href="https://api.karaokati.com/health" style="color: #0c5460;">Direct Health Check</a></li>
                  <li><a href="https://railway.app" style="color: #0c5460;">Railway Dashboard</a></li>
                  <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" style="color: #0c5460;">Workflow Logs</a></li>
                  <li><a href="https://github.com/${{ github.repository }}/actions" style="color: #0c5460;">All GitHub Actions</a></li>
                </ul>
              </div>
              
              <div style="background: #e2e3e5; padding: 10px; border-radius: 5px; margin: 15px 0 0 0; font-size: 12px; color: #6c757d;">
                <strong>Monitoring Info:</strong><br>
                ‚Ä¢ Frequency: Every 30 minutes<br>
                ‚Ä¢ Purpose: Sleep prevention + Health monitoring<br>
                ‚Ä¢ Repository: ${{ github.repository }}<br>
                ‚Ä¢ Workflow: ${{ github.workflow }}<br>
                ‚Ä¢ Run ID: ${{ github.run_id }}
              </div>
            </div>
          </div>'
          
          # Send email via Resend API
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"from\": \"Karaokati Alert <alerts@karaokati.com>\",
              \"to\": [\"${{ secrets.ADMIN_EMAIL }}\"],
              \"subject\": \"$EMAIL_SUBJECT\",
              \"html\": $(echo "$EMAIL_HTML" | jq -Rs .)
            }")
          
          # Check if email sent successfully
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          response_body=$(echo "$response" | sed '/HTTP_STATUS:/d')
          
          if [[ "$http_status" == "200" ]]; then
            echo "‚úÖ Alert email sent successfully via Resend"
            echo "üìß Email ID: $(echo "$response_body" | jq -r '.id // "unknown"')"
          else
            echo "‚ùå Failed to send email via Resend (HTTP $http_status)"
            echo "üìù Response: $response_body"
            echo "::error::Email alert failed - check RESEND_API_KEY secret"
          fi

      - name: ‚úÖ Success Log  
        if: steps.keepalive_check.outputs.SUCCESS == 'true'
        run: |
          echo "‚úÖ KEEP ALIVE SUCCESS - No alerts needed"
          echo "üéØ Benefits achieved:"
          echo "   ‚Ä¢ Sleep prevention: App stayed awake"
          echo "   ‚Ä¢ Health confirmed: App responding normally"
          echo "   ‚Ä¢ Response time: ${{ steps.keepalive_check.outputs.RESPONSE_TIME }}s"
          echo "üïê Next keep alive: in 30 minutes"
          
          # Log per tracking
          echo "::notice::Keep Alive Success - App healthy (${{ steps.keepalive_check.outputs.RESPONSE_TIME }}s response)"

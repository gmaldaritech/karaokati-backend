name: üßπ Cleanup Sessioni Scadute

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    name: Pulizia Sessioni
    
    steps:
      - name: üìã Info Cleanup
        run: |
          echo "üßπ Avvio cleanup sessioni scadute"
          echo "üìÖ Data: $(date)"
          echo "üåç Timezone: $(date +%Z)"
      
      - name: üîÑ Chiama endpoint cleanup
        id: cleanup_call
        run: |
          CLEANUP_URL="https://api.karaokati.com/api/v1/sessions/cleanup"
          
          echo "üì° Chiamando: $CLEANUP_URL"
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            --max-time 30 \
            --retry 3 \
            --retry-delay 5 \
            -X GET "$CLEANUP_URL")
          
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_STATUS:/d')
          
          echo "üìä Status: $http_status"
          echo "üìù Response: $body"
          
          echo "HTTP_STATUS=$http_status" >> $GITHUB_OUTPUT
          echo "RESPONSE_BODY=$body" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          
          if [ "$http_status" -eq 200 ]; then
            echo "‚úÖ Cleanup completato con successo!"
            echo "::notice::Sessioni pulite: $body"
            echo "SUCCESS=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Errore durante cleanup (HTTP $http_status)"
            echo "::error::Cleanup fallito: $body"
            echo "SUCCESS=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: üìß Send Success Email
        if: steps.cleanup_call.outputs.SUCCESS == 'true'
        run: |
          echo "üìß Sending cleanup success notification..."
          
          EMAIL_SUBJECT="‚úÖ KARAOKATI - Cleanup Sessioni Completato (${{ steps.cleanup_call.outputs.TIMESTAMP }})"
          EMAIL_HTML='<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: #28a745; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
              <h1 style="margin: 0; font-size: 24px;">‚úÖ Cleanup Sessioni Completato</h1>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border: 1px solid #dee2e6;">
              <h2 style="color: #28a745; margin-top: 0;">üéØ Operazione Completata</h2>
              
              <div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <h3 style="margin-top: 0; color: #495057;">üìä Dettagli:</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold; width: 40%;">Endpoint:</td>
                    <td style="padding: 8px 0;">https://api.karaokati.com/api/v1/sessions/cleanup</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Check Time:</td>
                    <td style="padding: 8px 0;">${{ steps.cleanup_call.outputs.TIMESTAMP }}</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Status HTTP:</td>
                    <td style="padding: 8px 0; color: #28a745;">${{ steps.cleanup_call.outputs.HTTP_STATUS }}</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Risultato:</td>
                    <td style="padding: 8px 0;">${{ steps.cleanup_call.outputs.RESPONSE_BODY }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold;">Prossimo cleanup:</td>
                    <td style="padding: 8px 0;">Domani alle 08:00 UTC</td>
                  </tr>
                </table>
              </div>
              
              <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745;">
                <p style="margin: 0; color: #155724;">‚úÖ <strong>Sistema funzionante:</strong> Cleanup automatico eseguito correttamente</p>
              </div>
              
              <div style="background: #e2e3e5; padding: 10px; border-radius: 5px; margin: 15px 0 0 0; font-size: 12px; color: #6c757d;">
                <strong>Monitoring Info:</strong><br>
                ‚Ä¢ Frequency: Daily at 08:00 UTC<br>
                ‚Ä¢ Purpose: Remove expired sessions<br>
                ‚Ä¢ Repository: ${{ github.repository }}<br>
                ‚Ä¢ Workflow: ${{ github.workflow }}<br>
                ‚Ä¢ Run ID: ${{ github.run_id }}
              </div>
            </div>
          </div>'
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"from\": \"Karaokati Maintenance <maintenance@karaokati.com>\",
              \"to\": \"${{ secrets.ADMIN_EMAIL }}\",
              \"subject\": \"$EMAIL_SUBJECT\",
              \"html\": $(echo "$EMAIL_HTML" | jq -Rs .)
            }")
          
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          
          if [[ "$http_status" == "200" ]]; then
            echo "‚úÖ Success email sent successfully!"
            echo "üìß Cleanup success notification delivered"
          else
            echo "‚ö†Ô∏è Failed to send success email (HTTP $http_status)"
            echo "::warning::Email notification failed but cleanup succeeded"
          fi

      - name: üìß Send Failure Email  
        if: failure()
        run: |
          echo "üìß Sending cleanup failure alert..."
          
          EMAIL_SUBJECT="üö® KARAOKATI CLEANUP FAILED - Sessioni (${{ steps.cleanup_call.outputs.TIMESTAMP }})"
          EMAIL_HTML='<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: #dc3545; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
              <h1 style="margin: 0; font-size: 24px;">üö® Cleanup Sessioni Fallito</h1>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border: 1px solid #dee2e6;">
              <h2 style="color: #dc3545; margin-top: 0;">‚ùå Errore nel Cleanup</h2>
              
              <div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <h3 style="margin-top: 0; color: #495057;">üîç Dettagli Errore:</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold; width: 40%;">Endpoint:</td>
                    <td style="padding: 8px 0;">https://api.karaokati.com/api/v1/sessions/cleanup</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Check Time:</td>
                    <td style="padding: 8px 0;">${{ steps.cleanup_call.outputs.TIMESTAMP || 'N/A' }}</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Status:</td>
                    <td style="padding: 8px 0; color: #dc3545;">${{ steps.cleanup_call.outputs.HTTP_STATUS || 'UNKNOWN' }}</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Errore:</td>
                    <td style="padding: 8px 0; color: #dc3545;">${{ steps.cleanup_call.outputs.RESPONSE_BODY || 'Timeout o errore di connessione' }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold;">Retries:</td>
                    <td style="padding: 8px 0;">3 attempts failed</td>
                  </tr>
                </table>
              </div>
              
              <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <h3 style="margin-top: 0; color: #856404;">üîß Immediate Actions Required:</h3>
                <ol style="margin: 0; padding-left: 20px; color: #856404;">
                  <li>Check <strong>Railway Dashboard</strong> for service status</li>
                  <li>Review <strong>deployment logs</strong> for errors</li>
                  <li>Verify <strong>database connectivity</strong></li>
                  <li>Consider <strong>manual redeploy</strong> if needed</li>
                  <li>Execute <strong>manual cleanup</strong> if necessary</li>
                </ol>
              </div>
              
              <div style="background: #d1ecf1; border: 1px solid #b8daff; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <h3 style="margin-top: 0; color: #0c5460;">üîó Quick Access Links:</h3>
                <ul style="margin: 0; padding-left: 20px; color: #0c5460;">
                  <li><a href="https://api.karaokati.com/api/v1/sessions/cleanup style="color: #0c5460;">Try it Out the API</a></li>
                  <li><a href="https://railway.app" style="color: #0c5460;">Railway Dashboard</a></li>
                  <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" style="color: #0c5460;">Workflow Logs</a></li>
                  <li><a href="https://github.com/${{ github.repository }}/actions" style="color: #0c5460;">All GitHub Actions</a></li>
                </ul>
              </div>
              
              <div style="background: #e2e3e5; padding: 10px; border-radius: 5px; margin: 15px 0 0 0; font-size: 12px; color: #6c757d;">
                <strong>Monitoring Info:</strong><br>
                ‚Ä¢ Frequency: Daily at 08:00 UTC<br>
                ‚Ä¢ Purpose: Remove expired sessions<br>
                ‚Ä¢ Repository: ${{ github.repository }}<br>
                ‚Ä¢ Workflow: ${{ github.workflow }}<br>
                ‚Ä¢ Run ID: ${{ github.run_id }}
              </div>
            </div>
          </div>'
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"from\": \"Karaokati Alerts <alerts@karaokati.com>\",
              \"to\": \"${{ secrets.ADMIN_EMAIL }}\",
              \"subject\": \"$EMAIL_SUBJECT\",
              \"html\": $(echo "$EMAIL_HTML" | jq -Rs .)
            }")
          
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          
          if [[ "$http_status" == "200" ]]; then
            echo "‚úÖ Failure alert sent successfully!"
            echo "üìß Admin notified of cleanup failure"
          else
            echo "‚ùå Failed to send failure email (HTTP $http_status)"
            echo "::error::Both cleanup AND email notification failed!"
          fi

      - name: üìä Final Status Log
        if: always()
        run: |
          echo ""
          echo "üèÅ === CLEANUP JOB SUMMARY ==="
          echo "üïê Completed at: $(date)"
          echo "üìä HTTP Status: ${{ steps.cleanup_call.outputs.HTTP_STATUS || 'N/A' }}"
          echo "‚úÖ Success: ${{ steps.cleanup_call.outputs.SUCCESS || 'false' }}"
          echo "üìß Email: Sent to admin"
          echo "üîÑ Next run: Tomorrow at 08:00 UTC"
          echo "================================"